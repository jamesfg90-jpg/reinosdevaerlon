<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cr√≥nicas de Vaerlon</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f1e4c3; --bg-2:#e3d3aa; --ink:#2e2a25; --ink-2:#5b5347;
  --accent:#7a3f1e; --accent-2:#b06c3b; --card:#fffaf0;
  --shadow:rgba(0,0,0,.12);
}
:root.dark{
  --bg:#151312; --bg-2:#1d1a17; --card:#1f1c19;
  --ink:#e7e1d8; --ink-2:#bfb6a8; --accent:#d6a15c; --accent-2:#f3c889;
  --shadow:rgba(0,0,0,.45);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:"EB Garamond",serif; color:var(--ink);
  background:linear-gradient(180deg,var(--bg),var(--bg-2));
}
h1,h2,h3,h4{font-family:"Cinzel",serif; letter-spacing:.5px; color:var(--ink)}
a{color:var(--accent); text-decoration:none}
.container{display:grid; grid-template-columns:280px 1fr; gap:18px; max-width:1400px; margin:0 auto; padding:16px}
@media (max-width:980px){ .container{grid-template-columns:1fr} }

/* Sidebar */
aside{
  position:sticky; top:12px; align-self:start; background:var(--card);
  border:1px solid rgba(0,0,0,.08); box-shadow:0 6px 18px var(--shadow);
  border-radius:14px; padding:14px
}
.brand{display:flex; align-items:center; gap:10px; margin-bottom:8px}
.brand .sigil{
  width:38px; height:38px; border-radius:50%;
  background: radial-gradient(60% 60% at 30% 30%, var(--accent-2), var(--accent));
  box-shadow: inset 0 0 0 2px rgba(0,0,0,.15), 0 2px 6px var(--shadow);
}
nav a{display:block; padding:10px; border-radius:10px; color:var(--ink-2); font-weight:500}
nav a.active, nav a:hover{background:rgba(0,0,0,.06); color:var(--ink)}
.controls{display:flex; gap:8px; margin:10px 0 14px}
button,.btn{font-family:inherit;border:none;background:var(--accent);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;box-shadow:0 3px 10px var(--shadow)}
button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
input[type="search"]{width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.15); background:#fff3; color:var(--ink)}

/* Main */
main{
  background:var(--card); border:1px solid rgba(0,0,0,.08);
  border-radius:16px; padding:18px; box-shadow:0 10px 24px var(--shadow);
  min-height:70vh
}

/* Hero */
.hero{
  position:relative; height:280px; border-radius:14px; margin-bottom:16px;
  background-position:center; background-size:cover; overflow:hidden
}
.hero::before{
  content:""; position:absolute; inset:0; background:rgba(0,0,0,.35);
  backdrop-filter:blur(2px);
}
.hero-overlay{position:relative; z-index:1; display:flex; align-items:center; justify-content:center; height:100%}
.hero-overlay h1{margin:0; font-size:2.8rem; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.6)}

/* Cards & grid */
.grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
.card{grid-column:span 6; background:var(--card); border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:14px; box-shadow:0 6px 12px var(--shadow)}
.card.small{grid-column:span 4}
.card.wide{grid-column:span 12}
.meta{font-size:14px; color:var(--ink-2)}
.tag{display:inline-block; padding:3px 8px; border-radius:999px; background:rgba(0,0,0,.08); margin-right:6px; font-size:.85rem}

/* Ticker */
.ticker{overflow:hidden}
.ticker-head{
  display:flex; align-items:center; gap:14px; margin-bottom:8px;
  border-bottom:1px solid rgba(0,0,0,.08); padding-bottom:8px; font-weight:700;
}
.ticker-body{min-height:74px; display:flex; align-items:center}
.ticker-item{display:flex; gap:10px; align-items:flex-start; animation:slideIn .4s ease}
.ticker-item .badge{
  font-size:.75rem; letter-spacing:1px; border:1px solid rgba(0,0,0,.15);
  padding:4px 6px; border-radius:6px; margin-top:3px; background:#2b3d55; color:#fff;
}
.ticker-item .title{font-weight:700; margin-bottom:2px}
.ticker-item .text{color:var(--ink-2)}
.ticker .controls{margin-left:auto; display:flex; gap:6px}
.ticker .controls button{padding:6px 8px}
@keyframes slideIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}

/* Intro */
.grim{ line-height:1.6; color:var(--ink-2); }

/* Galer√≠a de regiones */
.regions{ display:grid; grid-template-columns:repeat(4,1fr); gap:14px; }
@media(max-width:1100px){ .regions{grid-template-columns:repeat(2,1fr)} }
@media(max-width:640px){ .regions{grid-template-columns:1fr} }
.region{
  display:block; border:1px solid rgba(0,0,0,.08); border-radius:12px;
  overflow:hidden; box-shadow:0 6px 12px var(--shadow); background:var(--card);
  transform:translateZ(0);
}
.region:hover{ transform:translateY(-2px) }
.region-img{
  height:160px; background-size:cover; background-position:center;
  filter:contrast(1.05) saturate(1.05);
}
.region-info{ padding:10px }
.region-name{ font-family:"Cinzel",serif; font-weight:700 }

/* Tables */
table{width:100%; border-collapse:collapse; border:1px solid rgba(0,0,0,.1); border-radius:12px; overflow:hidden}
th,td{padding:10px; border-bottom:1px solid rgba(0,0,0,.06); text-align:left}
tbody tr:hover{background:rgba(0,0,0,.04)}

/* Map viewer */
.map-wrap{position:relative; overflow:hidden; border-radius:12px; border:1px solid rgba(0,0,0,.1); background:#cfe7f7}
#worldMap{transform-origin:0 0; cursor:grab; user-select:none; -webkit-user-drag:none; display:block; max-width:none}
.map-controls{position:absolute; right:8px; top:8px; display:flex; flex-direction:column; gap:6px}
.map-controls button{padding:6px 8px}
.marker{
  position:absolute; transform:translate(-50%,-50%); background:var(--accent); color:#fff; border-radius:50%;
  width:12px; height:12px; box-shadow:0 0 0 2px rgba(255,255,255,.85), 0 2px 6px var(--shadow)
}
.marker:hover::after{
  content:attr(data-name); position:absolute; left:14px; top:-2px; background:var(--card); color:var(--ink);
  padding:4px 8px; border-radius:8px; border:1px solid rgba(0,0,0,.1); white-space:nowrap
}

/* Footer */
footer{opacity:.85; font-size:.9rem; margin-top:16px}

/* Fallback de imagen */
.fallback{
  background-image:linear-gradient(135deg,#5f4634,#9b6a3f,#c8a56f);
  display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700;
}
</style>
</head>
<body>
<div class="container">
  <aside>
    <div class="brand"><div class="sigil"></div><div>
      <div style="font-family:Cinzel;font-weight:700;letter-spacing:1px">Cr√≥nicas de Vaerlon</div>
    </div></div>
    <div class="controls"><button class="ghost" id="toggleTheme" title="Tema claro/oscuro">üåì</button></div>
    <input id="search" type="search" placeholder="Buscar (reinos, PNJ, bestiario, aventuras‚Ä¶)" />
    <nav id="nav">
      <a href="#/inicio" class="active">üè† Inicio</a>
      <a href="#/lore">üìú Lore</a>
      <a href="#/cronologia">‚è≥ Cronolog√≠a</a>
      <a href="#/mapa">üó∫Ô∏è Mapa</a>
      <a href="#/reinos">üëë Reinos</a>
      <a href="#/pnj">üßô PNJ</a>
      <a href="#/bestiario">üêâ Bestiario</a>
      <a href="#/aventuras">üó°Ô∏è Aventuras</a>
      <a href="#/sesiones">üìù Registro</a>
      <a href="#/descargas">‚¨áÔ∏è Descargas</a>
    </nav>
  </aside>
  <main id="app"></main>
</div>

<footer class="container" style="padding-top:0">
  <div class="meta" style="grid-column:1/-1; text-align:center">
    ¬© Vaerlon ‚Äî tipograf√≠as: Cinzel & EB Garamond ¬∑ Modo claro/oscuro ¬∑ Single-page app
  </div>
</footer>

<script>
/* =========================
   DATA ‚Äî CONTENIDO COMPLETO
   ========================= */
const DATA = {
  settings: {
    worldName: "Vaerlon",
    heroImage: "20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png",
    mapImage: "Garia%202025-02-21-00-37.jpeg",
    // Marcadores aproximados en % sobre el mapa (aj√∫stalos al tuyo real)
    markers: [
      {name:"Valdrheim", x:18, y:12, link:"#/reinos/valdrheim"},
      {name:"Aeloria", x:42, y:28, link:"#/reinos/aeloria"},
      {name:"Thalassor", x:63, y:56, link:"#/reinos/thalassor"},
      {name:"Draevenhol", x:70, y:32, link:"#/reinos/draevenhol"},
      {name:"Elarion", x:48, y:70, link:"#/reinos/elarion"},
      {name:"Velrith", x:36, y:52, link:"#/reinos/velrith"},
      {name:"Harthkald", x:28, y:40, link:"#/reinos/harthkald"},
      {name:"Xakra", x:80, y:20, link:"#/reinos/xakra"}
    ]
  },

  news: [
    { title:"Contrataci√≥n urgente", text:"El **Fuerte Aulden** ofrece paga doble a mercenarios. Se requieren ballesteros y curanderos." },
    { title:"Puente derrumbado", text:"El puente de **Harrow-Fenn** ha sido destruido tras un ataque de trolls. Paso cerrado hasta nuevo aviso." },
    { title:"Mareas negras", text:"En **Clayard** la pesca muere; se investigan grietas submarinas y culto ilegal." },
    { title:"Edicto", text:"Por orden de **Aeloria**, queda prohibido el comercio de reliquias necrom√°nticas en mercados del sur." }
  ],

  lore: {
    intro: `
# Un mundo sin creadores
Vaerlon no fue moldeado por mano divina. Naci√≥ de fuerzas primordiales que aprendieron a persistir por s√≠ mismas. Los dioses miraron de reojo y siguieron de largo. El caos se templ√≥ en dragones; el tiempo les dio conciencia, y despu√©s sue√±o.

## El retiro de los dragones
Cuando comprendieron su lugar, los primeros se elevaron a los cielos y se apagaron como estrellas, otros descendieron al fondo del mar y algunos se hundieron en el coraz√≥n de la tierra. All√≠ sue√±an todav√≠a: su sue√±o es clima, corrientes y azar.

## El Grito de Krosh‚ÄôGar
Groomsh, curioso de tanta furia sin due√±o, envi√≥ a su campe√≥n. **Krosh‚ÄôGar el Indomable** habl√≥ con la tormenta hasta que √©sta quiso entenderle; el combate que sigui√≥ dio lugar a los **primeros orcos**, nacidos del eco de su grito y de la ceniza que a√∫n flotaba en el aire.

## Manifiesto de juego
La interpretaci√≥n en Vaerlon no es teatro: son **decisiones con consecuencias**. Aqu√≠ no hay profec√≠as que salven a nadie, solo elecciones que cambian el mundo.
    `,
    epochs: [
      {year:-1200, title:"A.E. ‚Äî Antes del Eclipse", text:"Era de imperios parlantes y magia sin freno."},
      {year:0, title:"E.D. ‚Äî Eclipse de los Dioses", text:"Tres d√≠as de tinieblas; la realidad se agriet√≥."},
      {year:843, title:"Grito de Krosh‚ÄôGar", text:"Del eco del campe√≥n nacieron los primeros clanes orcos."},
      {year:1461, title:"Pacto de Thalassor", text:"El mar impuso sus leyes a piratas y mercaderes."},
      {year:1688, title:"Cadenas en Draevenhol", text:"La esclavitud se hizo Senado y se visti√≥ de norma."}
    ]
  },

  // Reinos principales
  realms: [
    /* ======= VALDRHEIM (actualizado) ======= */
    { id:"valdrheim", name:"Valdrheim", sigil:"‚ùÑÔ∏è",
      blurb:"Monta√±as √°rticas al norte de Aurendell; capital Thelt; eruditos arcanos.",
      details:"Geograf√≠a monta√±osa y clima √°rtico, ambiente oscuro y silencioso. La oraci√≥n p√∫blica est√° mal vista: la magia se estudia, no se suplica. Mystra es la deidad principal (culto discreto). Hogar de colegios y logias arcanas, Valdrheim mantiene una **guerra fr√≠a** con Aeloria pese a la Triple Alianza.",
      img:"20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png",
      npcs:["ylva","thrain","edda","maelis"]
    },

    /* ======= AELORIA (actualizado) ======= */
    { id:"aeloria", name:"Aeloria", sigil:"‚õ™",
      blurb:"Valles y acantilados costeros al este de Aurendell; capital Brol; teocracia fervorosa.",
      details:"Clima templado y luminoso, ambiente marinero y devoto. Gobierno **teocr√°tico**; el fanatismo religioso gu√≠a justicia, guerra y diezmo. Se veneran Pelor, Ilm√°ter, Mielikki y otras deidades benignas o neutrales. Desconfianza hacia Valdrheim por su rechazo al rezo y la primac√≠a del estudio arcano.",
      img:"20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png",
      npcs:[]
    },

    /* ======= THALASSOR (igual) ======= */
    { id:"thalassor", name:"Thalassor", sigil:"‚öì",
      blurb:"Puertos, piratas y culto a criaturas abisales.",
      details:"El comercio manda; el mar decide.",
      img:"20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png",
      npcs:[]
    },

    /* ======= DRAEVENHOL (igual) ======= */
    { id:"draevenhol", name:"Draevenhol", sigil:"‚õìÔ∏è",
      blurb:"Imperio de cadenas.",
      details:"La ley es grillete; el Senado compra sombras.",
      img:"20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png",
      npcs:[]
    },

    /* ======= ELARION (igual) ======= */
    { id:"elarion", name:"Elarion", sigil:"üåø",
      blurb:"El canto del bosque eterno.",
      details:"Los elfos recuerdan lo que el mundo olvida.",
      img:"20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png",
      npcs:[]
    },

    /* ======= VELRITH (igual) ======= */
    { id:"velrith", name:"Velrith", sigil:"üïØÔ∏è",
      blurb:"Costa de medianos y gnomos astutos.",
      details:"Comercio discreto, talleres curiosos, pactos silenciosos.",
      img:"20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png",
      npcs:[]
    },

    /* ======= HARTHKALD (igual) ======= */
    { id:"harthkald", name:"Harthkald", sigil:"‚õèÔ∏è",
      blurb:"Reinos enanos bajo la monta√±a.",
      details:"Forjas profundas, juramentos viejos, puertas que solo se abren una vez.",
      img:"20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png",
      npcs:[]
    },

    /* ======= XAKRA (igual) ======= */
    { id:"xakra", name:"Xakra", sigil:"üî•",
      blurb:"Dominio demon√≠aco y cultos del caos.",
      details:"Torres negras, pactos de sangre y cenizas en la lluvia.",
      img:"20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png",
      npcs:[]
    },

    /* ======= AURENDELL (actualizado) ======= */
    { id:"aurendell", name:"Aurendell", sigil:"üëë",
      blurb:"Vasta regi√≥n occidental; capital Qosx; coraz√≥n del imperio y de la Triple Alianza.",
      details:"Dominio enorme de colinas, valles y bosques, con lagos, monta√±as y grandes caminos. **Clima templado** con zonas lluviosas y h√∫medas. Poblaci√≥n mayoritariamente **humana** (pero con todas las razas presentes). **Monarqu√≠a representativa** gobernada por tecn√≥cratas: poderes ejecutivo, legislativo y judicial compiten entre s√≠, cada uno con interminables √°reas de influencia. Existe **pobreza masiva**, incultura, superstici√≥n y **odio al diferente**. N√∫cleo pol√≠tico de la alianza con Aeloria y Valdrheim.",
      img:"20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png",
      npcs:[]
    }
  ],

  // PNJ (Valdrheim completos + algunos globales)
  npcs: [
    { id:"ylva", name:"Ylva la Umbranieve", realm:"valdrheim", role:"M√≠stica de las tormentas",
      bio:"Errante temida; oye susurros en el viento. La tormenta le obedece cuando quiere.",
      relevance:["Rituales del invierno","Presagios clim√°ticos","Magia primigenia del fr√≠o"] },
    { id:"thrain", name:"Thrain ¬´Cenizas Eternas¬ª", realm:"valdrheim", role:"Run√≥logo y forjador arcano",
      bio:"Reactiv√≥ una forja encantada. Escribe runas que tuercen la realidad; perdi√≥ un brazo en el intento.",
      relevance:["Forja r√∫nica","Artefactos dormidos","Runas prohibidas"] },
    { id:"edda", name:"Edda, Guardiana del Ojo de Hielo", realm:"valdrheim", role:"Or√°culo",
      bio:"Interpreta futuros fragmentados en una esfera antigua.",
      relevance:["Visiones trans-reino","Alertas tempranas","Elecci√≥n de campeones"] },
    { id:"maelis", name:"Maelis, el Exiliado del Alba", realm:"valdrheim", role:"Nigromante acad√©mico",
      bio:"Busca el l√≠mite √©tico de la muerte; desterrado por interrogar a un rey difunto.",
      relevance:["Rituales liminares","Amenazas sobrenaturales","Puente vida/muerte"] },

    { id:"varnek", name:"Varnek el de las Monedas", realm:"thalassor", role:"Corredor de contrabando",
      bio:"Sonr√≠e siempre; cada gesto es c√°lculo. Puerta al mercado negro costero.",
      relevance:["Rutas il√≠citas","Sobornos portuarios","Rumores de puerto"] },
    { id:"sor_ialen", name:"Sor Ialen", realm:"aeloria", role:"Archivista de reliquias",
      bio:"Catalog√≥ textos del Eclipse; combate herej√≠as con libros y paciencia.",
      relevance:["Artefactos santos","Herej√≠as","Red de monasterios"] },
    { id:"senrisa", name:"Sen‚ÄôRisa de los Tres Sellos", realm:"draevenhol", role:"Legista del Senado",
      bio:"Convierte cadenas en leyes; conoce vac√≠os legales para hacerlas eternas.",
      relevance:["Esclavitud legal","Espionaje civil","Corrupci√≥n de magistrados"] }
  ],

  // Bestiario sintetizado
  bestiary: [
    { name:"Espectro de bruma", cr:"7", habitat:"Costas de Thalassor", note:"Amarra barcos con fr√≠o que no moja."},
    { name:"Lobo de hielo ancestral", cr:"9", habitat:"Valdrheim", note:"La ventisca lo sigue."},
    { name:"Serpiente marina neblinosa", cr:"7", habitat:"Mar del Norte", note:"Ataca desde bancos de niebla."},
    { name:"Ogros de pantano", cr:"3", habitat:"Elarion (bordes)", note:"Piel verdosa, caza en parejas."},
    { name:"Sahuagin", cr:"2‚Äì3", habitat:"Thalassor", note:"Patrullas nocturnas."},
    { name:"Elemental de hielo", cr:"5", habitat:"Valdrheim", note:"Nace de grietas glaciares."},
    { name:"Harp√≠a de acantilado", cr:"3", habitat:"Aurendell norte", note:"Cantos de naufragio."},
    { name:"Sombras acu√°ticas", cr:"4", habitat:"Fosas marinas", note:"Ligadas a templos hundidos."},
    { name:"Marilith invocada", cr:"17", habitat:"Planos inferiores", note:"Amigos pocos, brazos muchos."},
    { name:"Kraken menor", cr:"10", habitat:"Abismos templados", note:"Rencor con velas y m√°stiles."}
  ],

  // Aventuras cortas listas
  adventures: [
    { title:"La Grieta de los N√°ufragos", where:"Clayard (Thalassor)", level:"2‚Äì4",
      hook:"La pesca muere; algo corrompe una grieta submarina. Barcos ‚Äúrespiran‚Äù niebla y no vuelven." },
    { title:"Las Runas que No Deben Ser", where:"Valdrheim", level:"8‚Äì10",
      hook:"Thrain necesita custodios para probar un patr√≥n prohibido. Si falla, nevada negra." },
    { title:"Piedras que Cantan", where:"Elarion (borde)", level:"4‚Äì6",
      hook:"Monolitos despiertan en la noche; un coro de √°rboles apunta a una tumba √©lfica." },
    { title:"Cadenas en el Mercado", where:"Draevenhol", level:"6‚Äì8",
      hook:"Un magistrado vende personas como deuda. Probarlo sin morir es la misi√≥n." },
    { title:"Los Juramentos del Muelle", where:"Thalassor", level:"3‚Äì5",
      hook:"El gremio exige diezmo a sangre. ¬øRomper la ley del muelle o firmarla?" },
    { title:"Humo bajo la Monta√±a", where:"Harthkald", level:"10‚Äì12",
      hook:"Una fragua antigua despierta sola. Los juramentos olvidados quieren cobrarse." }
  ],

  // Registro de sesi√≥n (ejemplo)
  sessions: [
    { date:"2025-02-21", title:"Sangre en Clayard",
      summary:"Nigromante y aldeanos zombificados. Se hall√≥ un grimorio menor; el culto no ha sido desarticulado."},
    { date:"2025-03-07", title:"Nieve en Valdrheim",
      summary:"El or√°culo de Edda mostr√≥ fragmentos de un drag√≥n dormido. Se acord√≥ vigilia en tres torres."},
    { date:"2025-03-28", title:"Juramentos en el Muelle",
      summary:"La banda de capas rojas impuso tributo. Un capit√°n perdi√≥ su mano por negarse."}
  ],

  // Descargas (enlaces que no rompen: SRD y archivos del propio repo)
  downloads: [
    {name:"SRD D&D 3.5 (EN)", href:"https://www.d20srd.org"},
    {name:"Mapa de Vaerlon (imagen)", href:"Garia%202025-02-21-00-37.jpeg"},
    {name:"Cabecera (fondo)", href:"20250828_1517_Paisaje Natural Renovado_remix_01k3rd15b4fd29q1yypr66mcyq.png"}
  ],

  // Regiones destacadas en portada (usa hero como imagen por defecto)
  regions: [
    { id:"valdrheim", name:"VALDRHEIM", img:null },
    { id:"elarion",   name:"ELARION",   img:null },
    { id:"thalassor", name:"THALASSOR", img:null },
    { id:"draevenhol",name:"DRAEVENHOL",img:null }
  ]
};

/* =========================
   Helpers
   ========================= */
const $ = (s,ctx=document)=>ctx.querySelector(s);
const $$ = (s,ctx=document)=>[...ctx.querySelectorAll(s)];
const app=$("#app");
const search=$("#search");

function setActive(href){
  $$("#nav a").forEach(a=>a.classList.toggle("active", a.getAttribute("href")===href));
}
function md(text=""){ // mini markdown simple
  return text
    .replace(/^### (.*$)/gim,'<h3>$1</h3>')
    .replace(/^## (.*$)/gim,'<h2>$1</h2>')
    .replace(/^# (.*$)/gim,'<h1>$1</h1>')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/\n\n/g,'<br/><br/>');
}

/* =========================
   P√°ginas
   ========================= */
function renderInicio(){
  app.innerHTML=`
  <section class="hero" style="background-image:url('${DATA.settings.heroImage}');">
    <div class="hero-overlay"><h1>Cr√≥nicas de ${DATA.settings.worldName}</h1></div>
  </section>

  <section class="ticker card">
    <div class="ticker-head">
      <div>üì∞ <span style="font-weight:700">Gaceta</span></div>
      <div class="controls"><button class="ghost" id="prevNews">‚óÄ</button><button class="ghost" id="nextNews">‚ñ∂</button></div>
    </div>
    <div class="ticker-body" id="tickerBody"></div>
  </section>

  <section class="card">
    <h3>Estado del Mundo</h3>
    <p class="grim">
      No hay profec√≠as que salven a nadie. Los puentes caen y las coronas pesan m√°s que las espadas.
      En Vaerlon, la lluvia no limpia: deja al descubierto lo que nadie quiso mirar. Los dragones duermen, pero sue√±an; y los hombres despiertos todav√≠a sangran por sus sue√±os.
    </p>
    <div style="margin-top:8px"><a class="btn" href="#/lore">Leer m√°s</a></div>
  </section>

  <section>
    <h3>Regiones</h3>
    <div class="regions">
      ${DATA.regions.map(r=>{
        const img = r.img || DATA.settings.heroImage;
        return `
        <a class="region" href="#/reinos/${r.id}" title="${r.name}">
          <div class="region-img" style="background-image:url('${img}');"></div>
          <div class="region-info">
            <div class="region-name">${r.name}</div>
          </div>
        </a>`;
      }).join('')}
    </div>
  </section>`;

  // ticker
  const body=$("#tickerBody"),prev=$("#prevNews"),next=$("#nextNews");
  let idx=0,paused=false;
  function paint(){
    const n=DATA.news[(idx%DATA.news.length+DATA.news.length)%DATA.news.length];
    body.innerHTML=`<div class="ticker-item"><div class="badge">GACETA</div><div><div class="title">${n.title}</div><div class="text">${md(n.text)}</div></div></div>`;
  }
  prev.onclick=()=>{idx--;paint()}; next.onclick=()=>{idx++;paint()};
  let timer=setInterval(()=>{if(!paused){idx++;paint()}},4500);
  body.onmouseenter=()=>paused=true; body.onmouseleave=()=>paused=false;
  paint();
}

function renderLore(){
  app.innerHTML = `
    <h1>Lore general</h1>
    <div class="card">${md(DATA.lore.intro)}</div>
    <div class="card"><h3>√âpocas & Hitos</h3>
      <table><thead><tr><th>A√±o</th><th>Evento</th><th>Descripci√≥n</th></tr></thead>
      <tbody>
        ${DATA.lore.epochs.map(e=>`<tr><td><strong>${e.year}</strong></td><td>${e.title}</td><td class="meta">${e.text}</td></tr>`).join('')}
      </tbody></table>
    </div>`;
}

function renderCronologia(){
  app.innerHTML = `<h1>Cronolog√≠a</h1>
  <div class="card">
    <input type="range" min="0" max="${DATA.lore.epochs.length-1}" value="${DATA.lore.epochs.length-1}" id="timelineRange" style="width:100%">
    <div id="timelineView" style="margin-top:12px"></div>
  </div>`;
  const range=$("#timelineRange"), view=$("#timelineView");
  const paint=()=>{
    const i=Number(range.value), e=DATA.lore.epochs[i];
    view.innerHTML = `<h3>${e.title}</h3><div class="meta">A√±o: ${e.year}</div><p>${e.text}</p>`;
  };
  range.oninput=paint; paint();
}

function renderMapa(){
  app.innerHTML = `
    <h1>Mapa del mundo</h1>
    <div class="card">
      <div class="map-wrap" id="mapWrap" style="height:520px">
        <img id="worldMap" alt="Mapa de ${DATA.settings.worldName}" src="${DATA.settings.mapImage}" />
        <div class="map-controls">
          <button id="zoomIn">Ôºã</button>
          <button id="zoomOut">Ôºç</button>
          <button id="zoomReset">‚ü≤</button>
        </div>
      </div>
      <div class="meta" style="margin-top:8px">Arrastra para mover, usa los botones para zoom. Pasa el rat√≥n sobre los marcadores para ver el nombre y haz clic para abrir.</div>
    </div>`;
  setupMap();
}

function renderReinos(){
  app.innerHTML = `<h1>Reinos</h1>
  <div class="grid">
    ${DATA.realms.map(r=>`
      <article class="card">
        <h3>${r.sigil} ${r.name}</h3>
        <div class="meta">${r.blurb}</div>
        <p>${r.details}</p>
        <div class="meta">PNJ: ${r.npcs.length? r.npcs.map(id=>DATA.npcs.find(n=>n.id===id)?.name||id).join(", "): "‚Äî"}</div>
        <div style="margin-top:8px"><a class="btn" href="#/reinos/${r.id}">Abrir ficha</a></div>
      </article>`).join('')}
  </div>`;
}

function renderReino(id){
  const r = DATA.realms.find(x=>x.id===id);
  if(!r){ app.innerHTML='<div class="card">Reino no encontrado.</div>'; return; }
  app.innerHTML = `
    <h1>${r.sigil} ${r.name}</h1>
    <div class="grid">
      <div class="card">${r.details}<br><br><span class="meta">${r.blurb}</span></div>
      <div class="card"><h3>PNJ de ${r.name}</h3>
        ${r.npcs.length? r.npcs.map(id=>{
          const n = DATA.npcs.find(x=>x.id===id);
          if(!n) return '';
          return `<div style="margin-bottom:10px"><strong>${n.name}</strong> ‚Äî <em>${n.role}</em><br><span class="meta">${n.bio}</span><br>
          <span class="meta">Relevancia: ${n.relevance.join(" ¬∑ ")}</span></div>`;
        }).join('<hr/>') : '<div class="meta">Sin PNJ cargados.</div>'}
      </div>
      <div class="card wide">
        <a class="btn" href="#/mapa">Ver en el mapa</a>
      </div>
    </div>`;
}

function renderPNJ(){
  app.innerHTML = `<h1>Personajes no jugadores</h1>
  <div class="grid">
    ${DATA.npcs.map(n=>`
      <div class="card small"><h3>${n.name}</h3>
        <div class="meta">${n.role} ‚Äî ${DATA.realms.find(r=>r.id===n.realm)?.name||'‚Äî'}</div>
        <p>${n.bio}</p><div class="meta">Relevancia: ${n.relevance.join(" ¬∑ ")}</div>
      </div>`).join('')}
  </div>`;
}

function renderBestiario(){
  app.innerHTML = `<h1>Bestiario</h1>
    <div class="card"><table><thead><tr><th>Criatura</th><th>CR</th><th>H√°bitat</th><th>Nota</th></tr></thead>
      <tbody>${DATA.bestiary.map(b=>`<tr><td><strong>${b.name}</strong></td><td>${b.cr}</td><td>${b.habitat}</td><td class="meta">${b.note}</td></tr>`).join('')}</tbody>
    </table></div>`;
}

function renderAventuras(){
  app.innerHTML = `<h1>Aventuras</h1>
  <div class="grid">
    ${DATA.adventures.map(a=>`
      <div class="card"><h3>${a.title}</h3>
      <div class="meta">${a.where} ‚Äî Niveles ${a.level}</div>
      <p>${a.hook}</p></div>`).join('')}
  </div>`;
}

function renderSesiones(){
  app.innerHTML = `<h1>Registro</h1>
  <div class="card">
    ${DATA.sessions.map(s=>`<div style="margin:8px 0"><strong>${s.date}</strong> ‚Äî ${s.title}<div class="meta">${s.summary}</div></div>`).join('<hr/>')}
  </div>`;
}

function renderDescargas(){
  app.innerHTML = `<h1>Descargas</h1>
  <div class="card">
    ${DATA.downloads.map(d=>`<div style="margin:.35rem 0"><a class="btn" href="${d.href}" target="_blank" rel="noopener">${d.name}</a></div>`).join('')}
    <div class="meta" style="margin-top:10px">Los archivos locales se sirven desde este mismo sitio. Sustituye o a√±ade los tuyos cuando quieras.</div>
  </div>`;
}

/* =========================
   Mapa: pan/zoom + marcadores
   ========================= */
function setupMap(){
  const wrap=$("#mapWrap"), img=$("#worldMap");
  let scale=1, origin={x:0,y:0}, dragging=false, start={x:0,y:0};

  img.onload=()=> placeMarkers();
  function placeMarkers(){
    $$(".marker",wrap).forEach(m=>m.remove());
    DATA.settings.markers.forEach(m=>{
      const el=document.createElement("a");
      el.className="marker"; el.href=m.link||"#"; el.dataset.name=m.name;
      el.style.left = (m.x)+"%"; el.style.top = (m.y)+"%";
      wrap.appendChild(el);
    });
  }
  const apply=()=> img.style.transform=`translate(${origin.x}px, ${origin.y}px) scale(${scale})`;
  $("#zoomIn").onclick=()=>{scale=Math.min(4,scale*1.2); apply();}
  $("#zoomOut").onclick=()=>{scale=Math.max(0.4,scale/1.2); apply();}
  $("#zoomReset").onclick=()=>{scale=1; origin={x:0,y:0}; apply();}
  img.onmousedown=(e)=>{dragging=true; img.style.cursor="grabbing"; start={x:e.clientX-origin.x,y:e.clientY-origin.y};}
  window.onmouseup=()=>{dragging=false; img.style.cursor="grab";}
  window.onmousemove=(e)=>{ if(!dragging) return; origin={x:e.clientX-start.x,y:e.clientY-start.y}; apply(); }
}

/* =========================
   B√∫squeda
   ========================= */
function doSearch(q){
  q=(q||"").trim().toLowerCase();
  if(!q){ router(); return; }
  const inRealm = DATA.realms.filter(r => (r.name+r.blurb+r.details).toLowerCase().includes(q));
  const inNPC   = DATA.npcs.filter(n => (n.name+n.bio+n.role).toLowerCase().includes(q));
  const inBeast = DATA.bestiary.filter(b => (b.name+b.habitat+b.note).toLowerCase().includes(q));
  const inAdv   = DATA.adventures.filter(a => (a.title+a.where+a.hook).toLowerCase().includes(q));
  app.innerHTML = `<h1>Resultados para ‚Äú${q}‚Äù</h1>
  <div class="card"><h3>Reinos</h3>${inRealm.length? inRealm.map(r=>`<div><a href="#/reinos/${r.id}">${r.name}</a> ‚Äî <span class="meta">${r.blurb}</span></div>`).join(''):'<div class="meta">‚Äî</div>'}</div>
  <div class="card"><h3>PNJ</h3>${inNPC.length? inNPC.map(n=>`<div><strong>${n.name}</strong> ‚Äî <em>${n.role}</em></div>`).join(''):'<div class="meta">‚Äî</div>'}</div>
  <div class="card"><h3>Bestiario</h3>${inBeast.length? inBeast.map(b=>`<div>${b.name} <span class="meta">(${b.habitat})</span></div>`).join(''):'<div class="meta">‚Äî</div>'}</div>
  <div class="card"><h3>Aventuras</h3>${inAdv.length? inAdv.map(a=>`<div><strong>${a.title}</strong> ‚Äî ${a.where}<br><span class="meta">${a.hook}</span></div>`).join(''):'<div class="meta">‚Äî</div>'}</div>`;
}
search.addEventListener("keydown",e=>{ if(e.key==="Enter") doSearch(search.value); });

/* =========================
   Tema y router
   ========================= */
const themeBtn=$("#toggleTheme");
function applyTheme(){ const t=localStorage.getItem("theme")||"light"; document.documentElement.classList.toggle("dark", t==="dark"); }
themeBtn.onclick=()=>{ const t=localStorage.getItem("theme")==="dark" ? "light" : "dark"; localStorage.setItem("theme",t); applyTheme(); };
applyTheme();

function router(){
  const hash = location.hash || "#/inicio";
  setActive(hash);
  const [_, route, param] = hash.split("/");
  switch(route){
    case "inicio": renderInicio(); break;
    case "lore": renderLore(); break;
    case "cronologia": renderCronologia(); break;
    case "mapa": renderMapa(); break;
    case "reinos": param? renderReino(param): renderReinos(); break;
    case "pnj": renderPNJ(); break;
    case "bestiario": renderBestiario(); break;
    case "aventuras": renderAventuras(); break;
    case "sesiones": renderSesiones(); break;
    case "descargas": renderDescargas(); break;
    default: renderInicio();
  }
  localStorage.setItem("lastRoute", hash);
}
window.addEventListener("hashchange", router);
router();
const last = localStorage.getItem("lastRoute"); if(last && last!==location.hash){ location.hash=last; }
</script>
</body>
</html>
