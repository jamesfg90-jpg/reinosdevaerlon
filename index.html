<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Cr√≥nicas de Vaerlon</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f1e4c3; --bg-2:#e3d3aa; --ink:#2e2a25; --ink-2:#5b5347;
  --accent:#7a3f1e; --accent-2:#b06c3b; --card:#fffaf0;
  --shadow:rgba(0,0,0,.12);
}
:root.dark{
  --bg:#151312; --bg-2:#1d1a17; --card:#1f1c19;
  --ink:#e7e1d8; --ink-2:#bfb6a8; --accent:#d6a15c; --accent-2:#f3c889;
  --shadow:rgba(0,0,0,.5);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:"EB Garamond",serif; color:var(--ink);
  background:linear-gradient(180deg,var(--bg),var(--bg-2));
}
h1,h2,h3,h4{font-family:"Cinzel",serif; letter-spacing:.5px; color:var(--ink)}
a{color:var(--accent); text-decoration:none}
.container{display:grid; grid-template-columns:280px 1fr; gap:18px; max-width:1400px; margin:0 auto; padding:16px}
@media (max-width:980px){ .container{grid-template-columns:1fr} }

/* Sidebar */
aside{
  position:sticky; top:12px; align-self:start; background:var(--card);
  border:1px solid rgba(0,0,0,.08); box-shadow:0 6px 18px var(--shadow);
  border-radius:14px; padding:14px
}
.brand{display:flex; align-items:center; gap:10px; margin-bottom:8px}
.brand .sigil{
  width:38px; height:38px; border-radius:50%;
  background: radial-gradient(60% 60% at 30% 30%, var(--accent-2), var(--accent));
  box-shadow: inset 0 0 0 2px rgba(0,0,0,.15), 0 2px 6px var(--shadow);
}
nav a{display:block; padding:10px; border-radius:10px; color:var(--ink-2); font-weight:500}
nav a.active, nav a:hover{background:rgba(0,0,0,.06); color:var(--ink)}
.controls{display:flex; gap:8px; margin:10px 0 14px}
button,.btn{font-family:inherit;border:none;background:var(--accent);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;box-shadow:0 3px 10px var(--shadow)}
button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
input[type="search"]{width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,.15); background:#fff3; color:var(--ink)}

/* Main */
main{
  background:var(--card); border:1px solid rgba(0,0,0,.08);
  border-radius:16px; padding:18px; box-shadow:0 10px 24px var(--shadow);
  min-height:70vh
}

/* Hero */
.hero{
  position:relative; height:280px; border-radius:14px; margin-bottom:16px;
  background-position:center; background-size:cover; overflow:hidden
}
.hero::before{
  content:""; position:absolute; inset:0;
  background:rgba(0,0,0,.45); backdrop-filter:blur(2px);
}
.hero-overlay{position:relative; z-index:1; display:flex; align-items:center; justify-content:center; height:100%}
.hero-overlay h1{margin:0; font-size:2.8rem; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.6)}

/* Cards & grid */
.grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
.card{grid-column:span 6; background:var(--card); border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:14px; box-shadow:0 6px 12px var(--shadow)}
.card.small{grid-column:span 4}
.card.wide{grid-column:span 12}
.meta{font-size:14px; color:var(--ink-2)}
.tag{display:inline-block; padding:3px 8px; border-radius:999px; background:rgba(0,0,0,.08); margin-right:6px; font-size:.85rem}

/* Tables */
table{width:100%; border-collapse:collapse; border:1px solid rgba(0,0,0,.1); border-radius:12px; overflow:hidden}
th,td{padding:10px; border-bottom:1px solid rgba(0,0,0,.06); text-align:left}
tbody tr:hover{background:rgba(0,0,0,.04)}

/* Map viewer */
.map-wrap{position:relative; overflow:hidden; border-radius:12px; border:1px solid rgba(0,0,0,.1); background:#cfe7f7}
#worldMap{transform-origin:0 0; cursor:grab; user-select:none; -webkit-user-drag:none; display:block; max-width:none}
.map-controls{position:absolute; right:8px; top:8px; display:flex; flex-direction:column; gap:6px}
.map-controls button{padding:6px 8px}
.marker{
  position:absolute; transform:translate(-50%,-50%); background:var(--accent); color:#fff; border-radius:50%;
  width:12px; height:12px; box-shadow:0 0 0 2px rgba(255,255,255,.8), 0 2px 6px var(--shadow)
}
.marker:hover::after{
  content:attr(data-name); position:absolute; left:14px; top:-2px; background:var(--card); color:var(--ink);
  padding:4px 8px; border-radius:8px; border:1px solid rgba(0,0,0,.1); white-space:nowrap
}

/* Footer */
footer{opacity:.8; font-size:.9rem; margin-top:16px; grid-column:1/-1; text-align:center}

/* Ticker / Banner rotativo */
.ticker{overflow:hidden}
.ticker-head{
  display:flex; align-items:center; gap:8px; margin-bottom:8px;
  border-bottom:1px solid rgba(0,0,0,.08); padding-bottom:8px;
}
.ticker .tab{
  padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:600;
  color:var(--ink-2);
}
.ticker .tab.active{ background:rgba(0,0,0,.06); color:var(--ink) }
.ticker .spacer{flex:1}
.ticker .controls button{padding:6px 8px}
.ticker-body{min-height:74px; display:flex; align-items:center}
.ticker-item{display:flex; gap:10px; align-items:flex-start; animation:slideIn .4s ease}
.ticker-item .badge{
  font-size:.75rem; letter-spacing:1px; border:1px solid rgba(0,0,0,.15);
  padding:4px 6px; border-radius:6px; margin-top:3px;
}
.ticker-item.imperial .badge{ background:#2b3d55; color:#fff; border-color:#2b3d55 }
.ticker-item.juglar .badge{ background:#6b3b20; color:#fff; border-color:#6b3b20 }
.ticker-item .title{font-weight:700; margin-bottom:2px}
.ticker-item .text{color:var(--ink-2)}
@keyframes slideIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}

/* Intro grimdark */
.grim{ line-height:1.5; color:var(--ink-2); }

/* Galer√≠a de regiones */
.regions{ display:grid; grid-template-columns:repeat(4,1fr); gap:14px; }
@media(max-width:1100px){ .regions{grid-template-columns:repeat(2,1fr)} }
@media(max-width:640px){ .regions{grid-template-columns:1fr} }
.region{
  display:block; border:1px solid rgba(0,0,0,.08); border-radius:12px;
  overflow:hidden; box-shadow:0 6px 12px var(--shadow); background:var(--card);
  transform:translateZ(0);
}
.region:hover{ transform:translateY(-2px) }
.region-img{
  height:160px; background-size:cover; background-position:center;
  filter:contrast(1.05) saturate(1.05);
}
.region-info{ padding:10px }
.region-name{ font-family:"Cinzel",serif; font-weight:700 }
.region-blurb{ color:var(--ink-2); font-size:.95rem }
</style>
</head>
<body>
<div class="container">
  <aside>
    <div class="brand"><div class="sigil"></div><div>
      <div style="font-family:Cinzel;font-weight:700;letter-spacing:1px">Cr√≥nicas de Vaerlon</div>
    </div></div>

    <div class="controls"><button class="ghost" id="toggleTheme" title="Tema claro/oscuro">üåì</button></div>
    <input id="search" type="search" placeholder="Buscar (reinos, PNJ, conjuros‚Ä¶)" />

    <nav id="nav">
      <a href="#/inicio" class="active">üè† Inicio</a>
      <a href="#/lore">üìú Lore</a>
      <a href="#/cronologia">‚è≥ Cronolog√≠a</a>
      <a href="#/mapa">üó∫Ô∏è Mapa</a>
      <a href="#/reinos">üëë Reinos</a>
      <a href="#/pnj">üßô PNJ</a>
      <a href="#/bestiario">üêâ Bestiario</a>
      <a href="#/aventuras">üó°Ô∏è Aventuras</a>
      <a href="#/sesiones">üìù Registro de sesi√≥n</a>
      <a href="#/descargas">‚¨áÔ∏è Descargas</a>
    </nav>
  </aside>

  <main id="app"><!-- contenido din√°mico --></main>
</div>

<footer class="container"><div class="meta">¬© Vaerlon ‚Äî Cinzel & EB Garamond</div></footer>

<script>
/* =========================
   DATA (edita aqu√≠)
   ========================= */
const DATA = {
  settings: {
    worldName: "Vaerlon",
    heroImage: "img/hero.jpg",
    // Si subiste el mapa con ese nombre en la ra√≠z del repo, usa la versi√≥n codificada:
    mapImage: "Garia%202025-02-21-00-37.jpeg",
    markers: [
      {name:"Valdrheim",  x:12.5, y:5.8,  link:"#/reinos/valdrheim"},
      {name:"Aeloria",    x:57.2, y:33.0, link:"#/reinos/aeloria"},
      {name:"Thalassor",  x:60.7, y:57.4, link:"#/reinos/thalassor"},
      {name:"Draevenhol", x:69.2, y:34.2, link:"#/reinos/draevenhol"},
      {name:"Elarion",    x:46.7, y:70.8, link:"#/reinos/elarion"},
      {name:"Velrith",    x:36.2, y:49.8, link:"#/reinos/velrith"}
    ]
  },

  /* Banner de noticias (imperiales y juglares) */
  news: [
    { type:"imperial", title:"Bando de la Prefectura", text:"El puente de **Harrow-Fenn** ha sido derrumbado por trolls. Se proh√≠be el paso hasta nueva orden." },
    { type:"juglar",   title:"Balada del Callej√≥n",    text:"Dicen que en **Clayard** las mareas devoran barcas sin luna; un ojo sin p√°rpado vigila el muelle." },
    { type:"imperial", title:"Contrataci√≥n urgente",   text:"El **Fuerte Aulden** ofrece paga doble a mercenarios. Se requieren ballesteros y curanderos." },
    { type:"juglar",   title:"Corrido de Sangre",      text:"En **Draevenhol** la noche compra hombres. Tres capas rojas cruzaron el mercado sin sombra." }
  ],

  /* Galer√≠a de regiones (pon tus im√°genes en /img/regions/ ) */
  regions: [
    { id:"valdrheim",  name:"Valdrheim",  img:"img/regions/valdrheim.jpg",  blurb:"Hielo y runas que respiran." },
    { id:"elarion",    name:"Elarion",    img:"img/regions/elarion.jpg",    blurb:"Bosques que recuerdan." },
    { id:"thalassor",  name:"Thalassor",  img:"img/regions/thalassor.jpg",  blurb:"Mareas y juramentos rotos." },
    { id:"korvvaraz",  name:"Korvvaraz",  img:"img/regions/korvvaraz.jpg",  blurb:"Arena, acero y silencio." }
  ],

  lore: {
    intro: `
**Un Mundo sin Creadores.** Vaerlon naci√≥ de fuerzas primordiales sin gu√≠a.
Los dragones tomaron forma y, tras su primera contienda, unos ascendieron, otros se hundieron,
y el m√°s antiguo descendi√≥ al n√∫cleo del mundo, donde a√∫n duerme.
`,
    epochs: [
      {year:-2000, title:"A.E. ‚Äî Antes del Eclipse", text:"Era de imperios y dioses parlantes; la magia flu√≠a sin freno."},
      {year:0,     title:"0 E.D. ‚Äî Eclipse de los Dioses", text:"Tres d√≠as de tinieblas; la realidad se resquebraj√≥."},
      {year:843,   title:"Grito de Krosh‚ÄôGar", text:"Del eco del campe√≥n orco nacieron los primeros clanes."},
      {year:1461,  title:"Pacto de Thalassor", text:"El mar impuso sus leyes a piratas y mercaderes."}
    ]
  },

  realms: [
    { id:"valdrheim", name:"Valdrheim", sigil:"‚ùÑÔ∏è",
      blurb:"Norte helado, bibliotecas arcanas y torres de cristal.",
      details:"El invierno piensa. Las √≥rdenes de magia estudian el hielo como voluntad viva.",
      npcs:["ylva","thrain","edda","maelis"]
    },
    { id:"aeloria", name:"Aeloria", sigil:"‚õ™", blurb:"Reino sagrado de templos y juramentos.", details:"Paladines y escribas sostienen el orden.", npcs:[] },
    { id:"thalassor", name:"Thalassor", sigil:"‚öì", blurb:"Puertos, piratas y culto a criaturas abisales.", details:"El comercio manda; el mar decide.", npcs:[] },
    { id:"draevenhol", name:"Draevenhol", sigil:"‚õìÔ∏è", blurb:"Imperio de cadenas.", details:"Sombras en el Senado.", npcs:[] },
    { id:"elarion", name:"Elarion", sigil:"üåø", blurb:"El canto del bosque eterno.", details:"Los elfos recuerdan; el mundo olvida.", npcs:[] },
    { id:"velrith", name:"Velrith", sigil:"üïØÔ∏è", blurb:"Costa de medianos y gnomos astutos.", details:"Comercio discreto y artes curiosas.", npcs:[] }
  ],

  npcs: [
    { id:"ylva", name:"Ylva la Umbranieve", realm:"valdrheim", role:"M√≠stica de las tormentas",
      bio:"Errante temida; oye susurros en el viento. La tormenta le obedece cuando quiere.",
      relevance:["Rituales del invierno","Presagios clim√°ticos","Magia primigenia del fr√≠o"] },
    { id:"thrain", name:"Thrain ¬´Cenizas Eternas¬ª", realm:"valdrheim", role:"Run√≥logo y forjador arcano",
      bio:"Reactiv√≥ una forja encantada. Escribe runas que tuercen la realidad; perdi√≥ un brazo en el intento.",
      relevance:["Forja r√∫nica","Artefactos dormidos","Runas prohibidas"] },
    { id:"edda", name:"Edda, Guardiana del Ojo de Hielo", realm:"valdrheim", role:"Or√°culo",
      bio:"Interpreta futuros fragmentados en una esfera antigua.",
      relevance:["Visiones trans-reino","Alertas tempranas","Elecci√≥n de campeones"] },
    { id:"maelis", name:"Maelis, el Exiliado del Alba", realm:"valdrheim", role:"Nigromante acad√©mico",
      bio:"Busca el l√≠mite √©tico de la muerte; desterrado por interrogar a un rey difunto.",
      relevance:["Rituales liminares","Amenazas sobrenaturales","Puente vida/muerte"] }
  ],

  bestiary: [
    { name:"Espectro de bruma", cr:"7", habitat:"Costas de Thalassor", note:"Amarra barcos con fr√≠o que no moja."},
    { name:"Lobo de hielo ancestral", cr:"9", habitat:"Valdrheim", note:"La ventisca lo sigue."}
  ],

  adventures: [
    { title:"La Grieta de los N√°ufragos", where:"Clayard (Thalassor)", level:"2‚Äì4", hook:"La pesca muere; algo corrompe una grieta submarina." },
    { title:"Las Runas que No Deben Ser", where:"Valdrheim", level:"8‚Äì10", hook:"Thrain necesita custodios para probar un patr√≥n prohibido." }
  ],

  sessions: [
    { date:"2025-02-21", title:"Sangre en Clayard", summary:"Nigromante y aldeanos zombificados. Se hall√≥ un grimorio menor."}
  ],

  downloads: [
    {name:"Hoja de personaje 3.5 (ES)", href:"https://example.com/hoja.pdf"},
    {name:"SRD 3.5", href:"https://www.d20srd.org/"}
  ]
};

/* =========================
   Helpers, router y vistas
   ========================= */
const $ = (sel,ctx=document)=>ctx.querySelector(sel);
const $$ = (sel,ctx=document)=>[...ctx.querySelectorAll(sel)];
const app = $("#app");
const search = $("#search");

function setActive(href){
  $$("#nav a").forEach(a=>a.classList.toggle("active", a.getAttribute("href")===href));
}
function md(text=""){ // mini markdown simple
  return text
    .replace(/^### (.*$)/gim,'<h3>$1</h3>')
    .replace(/^## (.*$)/gim,'<h2>$1</h2>')
    .replace(/^# (.*$)/gim,'<h1>$1</h1>')
    .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.*?)\*/g,'<em>$1</em>')
    .replace(/\n\n/g,'<br/><br/>');
}

/* ---- P√°ginas ---- */
function renderInicio(){
  app.innerHTML = `
  <section class="hero" style="background-image:url('${DATA.settings.heroImage}');">
    <div class="hero-overlay"><h1>Cr√≥nicas de ${DATA.settings.worldName}</h1></div>
  </section>

  <!-- Banner rotativo -->
  <section class="ticker card">
    <div class="ticker-head">
      <div class="tab active" data-filter="all">üì∞ Gaceta</div>
      <div class="tab" data-filter="imperial">‚öñÔ∏è Bando Imperial</div>
      <div class="tab" data-filter="juglar">üé∂ Coplas de Juglar</div>
      <div class="spacer"></div>
      <div class="controls">
        <button class="ghost" id="prevNews">‚óÄ</button>
        <button class="ghost" id="nextNews">‚ñ∂</button>
      </div>
    </div>
    <div class="ticker-body" id="tickerBody"></div>
    <div class="ticker-foot meta">Haz clic en las pesta√±as para filtrar noticias. Pasa el rat√≥n para pausar.</div>
  </section>

  <!-- Intro grimdark -->
  <section class="card">
    <h3>Estado del Mundo</h3>
    <p class="grim">
      No hay profec√≠as que salven a nadie. Los puentes caen, las ciudades arden con la misma calma con la que amanece,
      y las coronas pesan m√°s que las espadas. En Vaerlon, la lluvia no limpia: deja al descubierto lo que nadie quiso mirar.
      Los dragones duermen, pero sue√±an; y los hombres despiertos todav√≠a sangran por sus sue√±os.
    </p>
    <div style="margin-top:8px"><a class="btn" href="#/lore">Leer m√°s</a></div>
  </section>

  <!-- Galer√≠a de regiones -->
  <section>
    <h3>Regiones</h3>
    <div class="regions">
      ${DATA.regions.map(r=>`
        <a class="region" href="#/reinos/${r.id}" title="${r.name}">
          <div class="region-img" style="background-image:url('${r.img}');"></div>
          <div class="region-info">
            <div class="region-name">${r.name}</div>
            <div class="region-blurb">${r.blurb}</div>
          </div>
        </a>
      `).join('')}
    </div>
  </section>
  `;

  // --- l√≥gica del banner rotativo ---
  const body = $("#tickerBody");
  const prev = $("#prevNews"), next = $("#nextNews");
  const tabs = $$(".ticker .tab");
  let filter = "all";
  let idx = 0, paused = false;

  function filteredNews(){
    return DATA.news.filter(n => filter==="all" ? true : n.type===filter);
  }
  function paint(){
    const list = filteredNews();
    if(list.length===0){ body.innerHTML = `<div class="ticker-item meta">No hay avisos.</div>`; return; }
    const n = list[(idx % list.length + list.length) % list.length];
    body.innerHTML = `
      <div class="ticker-item ${n.type}">
        <div class="badge">${n.type==="imperial"?"BANDO":"COPLA"}</div>
        <div>
          <div class="title">${n.title}</div>
          <div class="text">${md(n.text)}</div>
        </div>
      </div>`;
  }
  function nextItem(){ idx++; paint(); }
  function prevItem(){ idx--; paint(); }

  let timer = setInterval(()=>{ if(!paused) nextItem(); }, 4500);
  body.addEventListener("mouseenter", ()=> paused=true);
  body.addEventListener("mouseleave", ()=> paused=false);
  next.onclick = nextItem; prev.onclick = prevItem;

  tabs.forEach(t=>{
    t.onclick = ()=>{
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      filter = t.dataset.filter;
      idx = 0; paint();
    };
  });

  paint();
}

function renderLore(){
  app.innerHTML = `
    <h1>Lore general</h1>
    <div class="card">${md(DATA.lore.intro)}</div>
    <div class="card"><h3>√âpocas & Hitos</h3>
      <table><thead><tr><th>A√±o</th><th>Evento</th><th>Descripci√≥n</th></tr></thead>
      <tbody>
        ${DATA.lore.epochs.map(e=>`<tr><td><strong>${e.year}</strong></td><td>${e.title}</td><td class="meta">${e.text}</td></tr>`).join('')}
      </tbody></table>
    </div>`;
}

function renderCronologia(){
  app.innerHTML = `<h1>Cronolog√≠a</h1>
  <div class="card">
    <input type="range" min="0" max="${DATA.lore.epochs.length-1}" value="${DATA.lore.epochs.length-1}" id="timelineRange" style="width:100%">
    <div id="timelineView" style="margin-top:12px"></div>
  </div>`;
  const range = $("#timelineRange");
  const view = $("#timelineView");
  const paint = ()=> {
    const idx = Number(range.value);
    const e = DATA.lore.epochs[idx];
    view.innerHTML = `<h3>${e.title}</h3><div class="meta">A√±o: ${e.year}</div><p>${e.text}</p>`;
  };
  range.oninput=paint; paint();
}

function renderMapa(){
  app.innerHTML = `
    <h1>Mapa del mundo</h1>
    <div class="card">
      <div class="map-wrap" id="mapWrap" style="height:480px">
        <img id="worldMap" alt="Mapa de ${DATA.settings.worldName}" src="${DATA.settings.mapImage}" />
        <div class="map-controls">
          <button id="zoomIn">Ôºã</button>
          <button id="zoomOut">Ôºç</button>
          <button id="zoomReset">‚ü≤</button>
        </div>
      </div>
      <div class="meta">Ajusta <code>DATA.settings.mapImage</code> y los marcadores en <code>DATA.settings.markers</code>.</div>
    </div>`;
  setupMap();
}

function renderReinos(){
  app.innerHTML = `<h1>Reinos</h1>
  <div class="grid">
    ${DATA.realms.map(r=>`
      <article class="card"><h3>${r.sigil} ${r.name}</h3>
      <div class="meta">${r.blurb}</div>
      <p>${r.details}</p>
      <div class="meta">PNJ: ${r.npcs.length? r.npcs.map(id=>DATA.npcs.find(n=>n.id===id)?.name||"‚Äî").join(", "): "‚Äî"}</div>
      <div style="margin-top:8px"><a class="btn" href="#/reinos/${r.id}">Abrir ficha</a></div>
      </article>`).join('')}
  </div>`;
}

function renderReino(id){
  const r = DATA.realms.find(x=>x.id===id);
  if(!r){ app.innerHTML='<div class="card">Reino no encontrado.</div>'; return; }
  app.innerHTML = `
    <h1>${r.sigil} ${r.name}</h1>
    <div class="grid">
      <div class="card">${r.details}<br><br><span class="meta">${r.blurb}</span></div>
      <div class="card"><h3>PNJ de ${r.name}</h3>
        ${r.npcs.length? r.npcs.map(id=>{
          const n = DATA.npcs.find(x=>x.id===id);
          return n? `<div style="margin-bottom:10px"><strong>${n.name}</strong> ‚Äî <em>${n.role}</em><br><span class="meta">${n.bio}</span><br>
          <span class="meta">Relevancia: ${n.relevance.join(" ¬∑ ")}</span></div>` : '';
        }).join('<hr/>') : '<div class="meta">Sin PNJ cargados.</div>'}
      </div>
      <div class="card wide">
        <a class="btn" href="#/mapa">Ver en el mapa</a>
      </div>
    </div>`;
}

function renderPNJ(){
  app.innerHTML = `<h1>Personajes no jugadores</h1>
  <div class="grid">
    ${DATA.npcs.map(n=>`
      <div class="card small"><h3>${n.name}</h3>
        <div class="meta">${n.role} ‚Äî ${DATA.realms.find(r=>r.id===n.realm)?.name||'‚Äî'}</div>
        <p>${n.bio}</p><div class="meta">Relevancia: ${n.relevance.join(" ¬∑ ")}</div>
      </div>`).join('')}
  </div>`;
}

function renderBestiario(){
  app.innerHTML = `<h1>Bestiario</h1>
    <div class="card"><table><thead><tr><th>Criatura</th><th>CR</th><th>H√°bitat</th><th>Nota</th></tr></thead>
      <tbody>${DATA.bestiary.map(b=>`<tr><td><strong>${b.name}</strong></td><td>${b.cr}</td><td>${b.habitat}</td><td class="meta">${b.note}</td></tr>`).join('')}</tbody>
    </table></div>`;
}

function renderAventuras(){
  app.innerHTML = `<h1>Aventuras</h1>
  <div class="grid">
    ${DATA.adventures.map(a=>`
      <div class="card"><h3>${a.title}</h3>
      <div class="meta">${a.where} ‚Äî Niveles ${a.level}</div>
      <p>${a.hook}</p></div>`).join('')}
  </div>`;
}

function renderSesiones(){
  app.innerHTML = `<h1>Registro de sesi√≥n</h1>
  <div class="card">
    ${DATA.sessions.map(s=>`<div style="margin:8px 0"><strong>${s.date}</strong> ‚Äî ${s.title}<div class="meta">${s.summary}</div></div>`).join('<hr/>')}
  </div>`;
}

function renderDescargas(){
  app.innerHTML = `<h1>Descargas</h1>
  <div class="card">
    ${DATA.downloads.map(d=>`<div style="margin:.35rem 0"><a class="btn" href="${d.href}" target="_blank" rel="noopener">${d.name}</a></div>`).join('')}
    <div class="meta" style="margin-top:10px">Sustituye los enlaces por tus archivos (GitHub Releases, Drive, etc.).</div>
  </div>`;
}

/* ---- Mapa: pan/zoom + marcadores ---- */
function setupMap(){
  const wrap=$("#mapWrap"), img=$("#worldMap");
  let scale=1, origin={x:0,y:0}, dragging=false, start={x:0,y:0};

  img.onload=()=> placeMarkers();
  function placeMarkers(){
    $$(".marker",wrap).forEach(m=>m.remove());
    DATA.settings.markers.forEach(m=>{
      const el=document.createElement("a");
      el.className="marker"; el.href=m.link||"#"; el.dataset.name=m.name;
      el.style.left = m.x+"%"; el.style.top = m.y+"%";
      wrap.appendChild(el);
    });
  }
  const apply=()=> img.style.transform=`translate(${origin.x}px, ${origin.y}px) scale(${scale})`;
  $("#zoomIn").onclick=()=>{scale=Math.min(4,scale*1.2); apply();}
  $("#zoomOut").onclick=()=>{scale=Math.max(0.4,scale/1.2); apply();}
  $("#zoomReset").onclick=()=>{scale=1; origin={x:0,y:0}; apply();}
  img.onmousedown=(e)=>{dragging=true; img.style.cursor="grabbing"; start={x:e.clientX-origin.x,y:e.clientY-origin.y};}
  window.onmouseup=()=>{dragging=false; img.style.cursor="grab";}
  window.onmousemove=(e)=>{ if(!dragging) return; origin={x:e.clientX-start.x,y:e.clientY-start.y}; apply(); }
}

/* ---- B√∫squeda ---- */
function doSearch(q){
  q=(q||"").trim().toLowerCase();
  if(!q){ renderInicio(); return; }
  const inRealm = DATA.realms.filter(r => (r.name+r.blurb+r.details).toLowerCase().includes(q));
  const inNPC   = DATA.npcs.filter(n => (n.name+n.bio+n.role).toLowerCase().includes(q));
  const inBeast = DATA.bestiary.filter(b => (b.name+b.habitat+b.note).toLowerCase().includes(q));
  const inAdv   = DATA.adventures.filter(a => (a.title+a.where+a.hook).toLowerCase().includes(q));
  app.innerHTML = `<h1>Resultados para ‚Äú${q}‚Äù</h1>
  <div class="card"><h3>Reinos</h3>${inRealm.length? inRealm.map(r=>`<div><a href="#/reinos/${r.id}">${r.name}</a> ‚Äî <span class="meta">${r.blurb}</span></div>`).join(''):'<div class="meta">‚Äî</div>'}</div>
  <div class="card"><h3>PNJ</h3>${inNPC.length? inNPC.map(n=>`<div><strong>${n.name}</strong> ‚Äî <em>${n.role}</em></div>`).join(''):'<div class="meta">‚Äî</div>'}</div>
  <div class="card"><h3>Bestiario</h3>${inBeast.length? inBeast.map(b=>`<div>${b.name} <span class="meta">(${b.habitat})</span></div>`).join(''):'<div class="meta">‚Äî</div>'}</div>
  <div class="card"><h3>Aventuras</h3>${inAdv.length? inAdv.map(a=>`<div><strong>${a.title}</strong> ‚Äî ${a.where}<br><span class="meta">${a.hook}</span></div>`).join(''):'<div class="meta">‚Äî</div>'}</div>`;
}
search.addEventListener("keydown",e=>{ if(e.key==="Enter") doSearch(search.value); });

/* ---- Tema y router ---- */
const themeBtn=$("#toggleTheme");
function applyTheme(){ const t=localStorage.getItem("theme")||"light"; document.documentElement.classList.toggle("dark", t==="dark"); }
themeBtn.onclick=()=>{ const t=localStorage.getItem("theme")==="dark" ? "light" : "dark"; localStorage.setItem("theme",t); applyTheme(); };
applyTheme();

function router(){
  const hash = location.hash || "#/inicio";
  setActive(hash);
  const [_, route, param] = hash.split("/");
  switch(route){
    case "inicio": renderInicio(); break;
    case "lore": renderLore(); break;
    case "cronologia": renderCronologia(); break;
    case "mapa": renderMapa(); break;
    case "reinos": param? renderReino(param): renderReinos(); break;
    case "pnj": renderPNJ(); break;
    case "bestiario": renderBestiario(); break;
    case "aventuras": renderAventuras(); break;
    case "sesiones": renderSesiones(); break;
    case "descargas": renderDescargas(); break;
    default: renderInicio();
  }
  localStorage.setItem("lastRoute", hash);
}
window.addEventListener("hashchange", router);
router();
const last = localStorage.getItem("lastRoute"); if(last && last!==location.hash){ location.hash=last; }
</script>
</body>
</html>
